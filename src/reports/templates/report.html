<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IWLARS Train Load Analysis Report</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 0;
            padding: 0;
        }
        .page {
            width: 210mm;
            height: 297mm;
            padding: 20mm;
            box-sizing: border-box;
            page-break-after: always;
            position: relative;
        }
        .header {
            text-align: center;
            margin-bottom: 20mm;
        }
        h1, h2, h3 {
            margin: 5mm 0;
        }
        .summary-table, .wagon-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10mm;
        }
        .summary-table th, .summary-table td, .wagon-table th, .wagon-table td {
            border: 1px solid #000;
            padding: 5mm;
            text-align: left;
        }
        .chart-container {
            width: 100%;
            height: 100mm;
            margin-bottom: 10mm;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .legend {
            text-align: center;
            margin-top: 5mm;
            font-size: 10pt;
        }
        .legend span {
            display: inline-block;
            width: 10px;
            height: 10px;
            margin-right: 5px;
            vertical-align: middle;
        }
        .footer {
            text-align: center;
            font-size: 8pt;
            position: absolute;
            bottom: 10mm;
            width: 100%;
            left: 0;
        }
        .qr-section { text-align: center; margin-top: 10mm; }
        ul {
            margin: 5mm 0;
            padding-left: 10mm;
        }
    </style>
</head>
<body>
    <!-- Page 1: Title Page -->
    <div class="page">
        <div class="header">
            <h1>IWLARS - Intelligent Wagon Load Analysis & Reporting System</h1>
            <h2>Train Load Analysis Report</h2>
            <p>Date: {{ stats.date if stats.date else '' }}</p>
            <p>Total Wagons: {{ stats.total_wagons }}</p>
            <h3>Quick Summary</h3>
            <p>Total Load: {{ '%.1f' % stats.total_load }} tons</p>
            <p>Total Volume: {{ '%.1f' % stats.total_volume }} m³</p>
            <p>Average Balance Deviation: {{ '%.1f' % stats.avg_balance }}%</p>
            <p>
                Overloaded Wagons: {{ stats.status_counts.get('Overloaded', 0) }} |
                Unbalanced Wagons: {{ stats.status_counts.get('Unbalanced', 0) }} |
                Normal Wagons: {{ stats.status_counts.get('Normal', 0) }} |
                Empty Wagons: {{ stats.status_counts.get('Empty', 0) }}
            </p>
        </div>
        {% if qr_code %}
        <div class="qr-section">
            <h3>Scan for Online Report</h3>
            <img src="{{ qr_code }}" alt="QR Code" width="120" height="120"/>
        </div>
        {% endif %}
        <div class="footer">
            Confidential - IWLARS | Page 1
        </div>
    </div>

    <!-- Page 2: Executive Summary -->
    <div class="page">
        <h2>Executive Summary</h2>
        <h3>Train Overview</h3>
        <table class="summary-table">
            <tr><th>Metric</th><th>Value</th></tr>
            <tr><td>Total Wagons</td><td>{{ stats.total_wagons }}</td></tr>
            <tr><td>Total Estimated Load</td><td>{{ '%.1f' % stats.total_load }} tons</td></tr>
            <tr><td>Total Volume</td><td>{{ '%.1f' % stats.total_volume }} m³</td></tr>
            <tr><td>Average Balance Deviation</td><td>{{ '%.1f' % stats.avg_balance }}%</td></tr>
            <tr><td>Empty Wagons</td><td>{{ stats.status_counts.get('Empty', 0) }}</td></tr>
            <tr><td>Overloaded Wagons</td><td>{{ stats.status_counts.get('Overloaded', 0) }}</td></tr>
            <tr><td>Unbalanced Wagons</td><td>{{ stats.status_counts.get('Unbalanced', 0) }}</td></tr>
            <tr><td>Normal Wagons</td><td>{{ stats.status_counts.get('Normal', 0) }}</td></tr>
        </table>
        <h3>Wagon Status Distribution</h3>
        <table class="summary-table">
            <tr><th>Status</th><th>Count</th><th>Percentage</th></tr>
            {% for status, count in stats.status_counts.items() %}
            <tr>
                <td>{{ status }}</td>
                <td>{{ count }}</td>
                <td>{{ '%.1f' % (100 * count / stats.total_wagons) }}%</td>
            </tr>
            {% endfor %}
        </table>
        <div class="footer">
            Confidential - IWLARS | Page 2
        </div>
    </div>

    <!-- Page 3: Data Visualization 1/5 - Pie Chart -->
    <div class="page">
        <h2>Data Visualization 1/5</h2>
        <h3>Pie Chart - Status Distribution</h3>
        <div class="chart-container">
            <img src="{{ charts.pie }}" alt="Status Pie Chart" style="max-width: 400px; max-height: 400px;"/>
        </div>
        <div class="footer">
            Confidential - IWLARS | Page 3
        </div>
    </div>

    <!-- Page 4: Data Visualization 2/5 - Bar Chart -->
    <div class="page">
        <h2>Data Visualization 2/5</h2>
        <h3>Bar Chart - Volume Distribution</h3>
        <div class="chart-container">
            <img src="{{ charts.bar }}" alt="Volume Bar Chart"/>
        </div>
        <div class="footer">
            Confidential - IWLARS | Page 4
        </div>
    </div>

    <!-- Page 5: Data Visualization 3/5 - Line Chart -->
    <div class="page">
        <h2>Data Visualization 3/5</h2>
        <h3>Line Chart - Balance Deviation Trend</h3>
        <div class="chart-container">
            <img src="{{ charts.line }}" alt="Balance Line Chart"/>
        </div>
        <div class="footer">
            Confidential - IWLARS | Page 5
        </div>
    </div>

    <!-- Page 6: Data Visualization 4/5 - Scatter Plot -->
    <div class="page">
        <h2>Data Visualization 4/5</h2>
        <h3>Scatter Plot - Weight vs Volume</h3>
        <div class="chart-container">
            <img src="{{ charts.scatter }}" alt="Weight vs Volume Scatter"/>
        </div>
        <div class="footer">
            Confidential - IWLARS | Page 6
        </div>
    </div>

    <!-- Page 7: Data Visualization 5/5 - Histogram -->
    <div class="page">
        <h2>Data Visualization 5/5</h2>
        <h3>Histogram - Wagon Volumes</h3>
        <div class="chart-container">
            <img src="{{ charts.hist }}" alt="Volume Histogram"/>
        </div>
        <div class="footer">
            Confidential - IWLARS | Page 7
        </div>
    </div>

    <!-- Page 8: Detailed Wagon Analytics -->
    <div class="page">
        <h2>Detailed Wagon Analytics</h2>
        <table class="wagon-table">
            <tr>
                <th>Wagon</th>
                <th>Status</th>
                <th>Volume (m³)</th>
                <th>Weight (tons)</th>
                <th>Centroid</th>
            </tr>
            {% for a in analytics %}
            <tr>
                <td>{{ a.wagon_id }}</td>
                <td>{{ a.status }}</td>
                <td>{{ '%.1f' % a.metrics.volume }}</td>
                <td>{{ '%.1f' % a.metrics.weight }}</td>
                <td>{{ a.metrics.centroid }}</td>
            </tr>
            {% endfor %}
        </table>
        <div class="footer">
            Confidential - IWLARS | Page 8
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Sample data (only wagons 1-10 provided; extend with full data in practice)
            const sampleVolumes = [66.6, 79.9, 59.3, 68.8, 58.1, 71.2, 0, 56.4, 63.6, 64.6];
            const sampleWeights = [56.6, 50.1, 46.5, 39.6, 53.2, 47.1, 0, 43.5, 42.1, 36.2];
            const sampleLRBalances = [2.8, 2.3, 1.3, 3.1, 1, 1.8, 0, 1.4, 3.2, 2.7];
            const sampleTBBalances = [1.9, 1, 0.9, 0.2, 2.1, 2.5, 0, 0.1, 2.2, 0.2];
            const sampleStatuses = ['Normal', 'Normal', 'Normal', 'Normal', 'Normal', 'Normal', 'Empty', 'Normal', 'Normal', 'Normal'];
            const statusColors = {
                'Normal': '#36a2eb',
                'Empty': '#ffcd56',
                'Overloaded': '#ff6384',
                'Unbalanced': '#cc65fe'
            };

            // Extend to 87 wagons (placeholder data)
            const volumes = sampleVolumes.concat(Array(77).fill(60)); // Assuming avg ~60 m³
            const weights = sampleWeights.concat(Array(77).fill(45)); // Assuming avg ~45 tons
            const lrBalances = sampleLRBalances.concat(Array(77).fill(2)); // Assuming avg ~2%
            const tbBalances = sampleTBBalances.concat(Array(77).fill(1)); // Assuming avg ~1%
            const statuses = sampleStatuses.concat(Array(73).fill('Normal'), Array(4).fill('Overloaded'), Array(3).fill('Unbalanced')); // Matches summary

            // Pie Chart
            var pieCtx = document.getElementById('statusPieChart').getContext('2d');
            new Chart(pieCtx, {
                type: 'pie',
                data: {
                    labels: ['Normal', 'Empty', 'Overloaded', 'Unbalanced'],
                    datasets: [{
                        data: [73, 7, 4, 3],
                        backgroundColor: ['#36a2eb', '#ffcd56', '#ff6384', '#cc65fe']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: { position: 'bottom' },
                        title: { display: true, text: 'Wagon Status Distribution' }
                    }
                }
            });

            // Bar Chart
            var barCtx = document.getElementById('volumeBarChart').getContext('2d');
            new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: Array.from({length: 87}, (_, i) => `WGN-${String(i+1).padStart(3, '0')}`),
                    datasets: [{
                        label: 'Volume (m³)',
                        data: volumes,
                        backgroundColor: statuses.map(s => statusColors[s])
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: {
                                callback: function(value, index) {
                                    return index % 10 === 0 ? this.getLabelForValue(value) : '';
                                }
                            }
                        },
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        legend: { display: false },
                        title: { display: true, text: 'Volume Distribution Across Wagons' }
                    }
                }
            });

            // Line Chart
            var lineCtx = document.getElementById('balanceLineChart').getContext('2d');
            new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: Array.from({length: 87}, (_, i) => `WGN-${String(i+1).padStart(3, '0')}`),
                    datasets: [
                        { label: 'L-R Balance (%)', data: lrBalances, borderColor: '#ff6384', fill: false },
                        { label: 'T-B Balance (%)', data: tbBalances, borderColor: '#36a2eb', fill: false }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            ticks: {
                                callback: function(value, index) {
                                    return index % 10 === 0 ? this.getLabelForValue(value) : '';
                                }
                            }
                        },
                        y: { beginAtZero: true }
                    },
                    plugins: {
                        title: { display: true, text: 'Balance Deviation Trends Across Wagons' }
                    }
                }
            });

            // Scatter Plot
            var scatterCtx = document.getElementById('weightVolumeScatter').getContext('2d');
            const dataPoints = weights.map((w, i) => ({ x: w, y: volumes[i] }));
            const pointColors = statuses.map(s => statusColors[s]);
            new Chart(scatterCtx, {
                type: 'scatter',
                data: {
                    datasets: [{
                        label: 'Wagons',
                        data: dataPoints,
                        backgroundColor: pointColors
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Weight (tons)' } },
                        y: { title: { display: true, text: 'Volume (m³)' } }
                    },
                    plugins: {
                        title: { display: true, text: 'Correlation between Weight and Volume' }
                    }
                }
            });

            // Histogram
            var histCtx = document.getElementById('weightHistogram').getContext('2d');
            const bins = [0, 10, 20, 30, 40, 50, 60, 70, 80, 90];
            const binCounts = bins.slice(1).map((bin, i) => {
                const lower = bins[i];
                return weights.filter(w => w >= lower && w < bin).length;
            });
            new Chart(histCtx, {
                type: 'bar',
                data: {
                    labels: ['0-10', '10-20', '20-30', '30-40', '40-50', '50-60', '60-70', '70-80', '80-90'],
                    datasets: [{
                        label: 'Number of Wagons',
                        data: binCounts,
                        backgroundColor: '#36a2eb'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: { title: { display: true, text: 'Weight (tons)' } },
                        y: { beginAtZero: true, title: { display: true, text: 'Frequency' } }
                    },
                    plugins: {
                        title: { display: true, text: 'Weight Distribution Histogram' }
                    }
                }
            });
        });
    </script>
</body>
</html>